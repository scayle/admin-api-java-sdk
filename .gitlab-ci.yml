stages:
  - deploy

default:
  image: node:buster
  services:
    - docker:dind
  tags:
    - $GITLAB_CI_RUNNER_AMD
  before_script:
    - apt-get update
    - apt-get install -y openjdk-11-jdk
    - sh ./gradlew clean

.deploy_template: &deploy_template
  stage: deploy
  script:
    - export ORG_GRADLE_PROJECT_version="${CI_COMMIT_TAG/v}"
    - sed -i "0,/SDK_VERSION_PLACEHOLDER/s//${ORG_GRADLE_PROJECT_version}/" ./src/main/java/com/scayle/adminapi/http/HttpClient.java
    - export ORG_GRADLE_PROJECT_environment

    - export JRELEASER_MAVEN_CENTRAL_USERNAME="${ORG_GRADLE_PROJECT_nexusUsername}"
    - export JRELEASER_MAVEN_CENTRAL_PASSWORD="${ORG_GRADLE_PROJECT_nexusPassword}"
    - export JRELEASER_GPG_SECRET_KEY="${ORG_GRADLE_PROJECT_signingKey}"
    - export JRELEASER_GPG_SECRET_KEY_ID="${ORG_GRADLE_PROJECT_signingKeyId}"
    - export JRELEASER_GPG_PASSPHRASE="${ORG_GRADLE_PROJECT_signingPassword}"

    - sh ./gradlew jreleaserPublish --info
  # only:
  #   - tags
  when: manual

deploy:snapshot:
  <<: *deploy_template
  variables:
    ORG_GRADLE_PROJECT_environment: snapshot

deploy:release:
  <<: *deploy_template
  variables:
    ORG_GRADLE_PROJECT_environment: release
